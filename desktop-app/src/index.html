<!DOCTYPE html>
<html>
  <head>
    <title>Audio Listener AI - Desktop (Fixed)</title>
    <link rel="stylesheet" href="./style.css" />
    <!-- Add Socket.IO client library -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <!-- Add marked library for markdown rendering -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"
    ></script>

    <!-- Create a global Socket.IO instance -->
    <script>
      // Global variables for Socket.IO
      var globalSocket = null;
      var isGlobalSocketConnected = false;

      // Function to connect to Socket.IO server
      function connectGlobalSocket(url) {
        try {
          // Create a new Socket.IO connection
          globalSocket = io(url, {
            transports: ["websocket", "polling"],
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000,
            autoConnect: true,
            forceNew: true,
          });

          // Set up event handlers
          globalSocket.on("connect", function () {
            isGlobalSocketConnected = true;

            // Update status
            var statusElement = document.getElementById("global-socket-status");
            if (statusElement) {
              statusElement.textContent = "Connected";
              statusElement.style.backgroundColor = "#4CAF50";
            }
          });

          globalSocket.on("connect_error", function (error) {
            isGlobalSocketConnected = false;

            // Update status
            var statusElement = document.getElementById("global-socket-status");
            if (statusElement) {
              statusElement.textContent = "Connection Error";
              statusElement.style.backgroundColor = "#F44336";
            }
          });

          globalSocket.on("disconnect", function (reason) {
            isGlobalSocketConnected = false;

            // Update status
            var statusElement = document.getElementById("global-socket-status");
            if (statusElement) {
              statusElement.textContent = "Disconnected";
              statusElement.style.backgroundColor = "#FF9800";
            }
          });

          // Set up event listeners for common events
          globalSocket.on("transcript", function (data) {
            // Display the transcript
            var questionElement = document.getElementById("question");
            if (questionElement) {
              questionElement.innerHTML =
                "<strong>Question:</strong> " + data.transcript;
            }
          });

          globalSocket.on("streamChunk", function (data) {
            // Append the chunk to the answer
            if (data && data.chunk) {
              var answerElement = document.getElementById("answer");
              if (answerElement) {
                // Create or update the answer content
                var contentElement = document.getElementById(
                  "global-answer-content"
                );
                if (!contentElement) {
                  answerElement.innerHTML =
                    "<strong>Answer:</strong><div id='global-answer-content'></div>";
                  contentElement = document.getElementById(
                    "global-answer-content"
                  );
                }

                if (contentElement) {
                  // Append the chunk and render as markdown using our utility if available
                  if (typeof window.markdownUtils !== "undefined") {
                    contentElement.innerHTML +=
                      window.markdownUtils.parseMarkdown(data.chunk);
                  } else {
                    contentElement.innerHTML += marked.parse(data.chunk);
                  }
                }
              }
            }
          });

          globalSocket.on("streamEnd", function (data) {
            // Ensure the final content is rendered as markdown
            var contentElement = document.getElementById(
              "global-answer-content"
            );
            if (contentElement) {
              // Use our markdown utility if available
              if (typeof window.markdownUtils !== "undefined") {
                contentElement.innerHTML = window.markdownUtils.parseMarkdown(
                  contentElement.innerHTML
                );
              } else {
                contentElement.innerHTML = marked.parse(
                  contentElement.innerHTML
                );
              }
            }

            // Update status to Idle
            var statusElement = document.getElementById("status");
            if (statusElement) {
              statusElement.textContent = "Status: Idle";
              statusElement.className = "status idle";
            }
            var loadingElement = document.getElementById("loading");
            if (loadingElement) {
              loadingElement.style.display = "none";
            }

            // Reset button states
            var toggleBtn = document.getElementById("toggleBtn");
            var retryBtn = document.getElementById("retryBtn");
            var geminiBtn = document.getElementById("geminiBtn");
            var cancelBtn = document.getElementById("cancelBtn");

            if (toggleBtn) {
              toggleBtn.disabled = false;
              toggleBtn.textContent = "Start Listening";
            }
            if (retryBtn) retryBtn.disabled = false;
            if (geminiBtn) retryBtn.disabled = false;
            if (cancelBtn) cancelBtn.disabled = true;

            // Update recording state
            window.isRecording = false;

            // Update follow-up checkbox state
            if (typeof window.updateFollowUpCheckbox === "function") {
              window.updateFollowUpCheckbox();
            }
          });

          // Add listener for transcription response
          globalSocket.on("transcriptionResponse", function (data) {
            // Display the transcript
            var questionElement = document.getElementById("question");
            if (questionElement && data.transcript) {
              questionElement.innerHTML =
                "<strong>Question:</strong> " + data.transcript;
            }
          });

          // Add listener for error response
          globalSocket.on("transcriptionError", function (data) {
            // Handle error, maybe update status or display an error message
          });

          return true;
        } catch (error) {
          console.error("Error creating global Socket.IO connection:", error);
          return false;
        }
      }

      // Automatically connect after a short delay
      setTimeout(function () {
        if (typeof io !== "undefined") {
          console.log(
            "Socket.IO is available globally, attempting connection..."
          );
          connectGlobalSocket("http://localhost:3033"); // Automatically connect
        } else {
          console.error("Socket.IO is not available globally");
          alert(
            "Socket.IO is not available globally. The application may not function correctly."
          );
        }
      }, 2000);
    </script>
  </head>
  <body>
    <h1>Audio Listener AI - Desktop (Fixed Version)</h1>

    <div id="language-selection">
      <strong>Language:</strong>
      <label>
        <input type="radio" name="language" value="vi" />
        Vietnamese
      </label>
      <label>
        <input type="radio" name="language" value="en" checked />
        English
      </label>
    </div>

    <div id="question-context-selection">
      <strong>Question Context:</strong>
      <select name="questionContext">
        <option value="interview">General interview question</option>
        <option value="general" selected>
          General about frontend development
        </option>
        <option value="html/css/javascript">HTML/CSS/JavaScript</option>
        <option value="typescript">TypeScript</option>
        <option value="reactjs">React.js</option>
        <option value="nextjs">Next.js</option>
      </select>
    </div>

    <details id="custom-context-container">
      <summary><strong>Custom Context</strong></summary>
      <textarea
        id="customContextInput"
        name="customContext"
        placeholder="Add custom instructions for AI (will be applied to every response)"
        rows="3"
      ></textarea>
    </details>

    <div class="status idle" id="status">Status: Idle</div>
    <div id="loading" class="status loading">
      <div class="loader"></div>
      <span>Processing your question...</span>
    </div>

    <div id="follow-up-selection">
      <label>
        <input
          type="checkbox"
          name="isFollowUp"
          id="isFollowUpCheckbox"
          disabled
        />
        Ask a follow-up question
      </label>
    </div>

    <div id="audio-source-selection" style="margin-bottom: 10px">
      <strong>Audio Source:</strong>
      <label>
        <input
          type="radio"
          name="audioSource"
          value="microphone"
          checked
          onchange="selectAudioSource('microphone')"
        />
        Microphone
      </label>
      <label>
        <input
          type="radio"
          name="audioSource"
          value="system"
          onchange="selectAudioSource('system')"
        />
        System Audio
      </label>
    </div>

    <div id="audio-device-selection" style="margin-bottom: 15px">
      <strong>Audio Input Device:</strong>
      <select id="audioDeviceSelect" onchange="selectAudioDevice(this.value)">
        <option value="">Loading devices...</option>
      </select>
      <button
        onclick="refreshAudioDevices()"
        id="refreshDevicesBtn"
        title="Refresh device list"
      >
        ðŸ”„
      </button>
    </div>

    <button onclick="toggleRecording()" id="toggleBtn">Start Listening</button>
    <button onclick="retryTranscription()" id="retryBtn" disabled>
      Try Different Recognition
    </button>
    <button onclick="processWithGemini()" id="geminiBtn" disabled>
      Try Gemini AI directly
    </button>
    <button onclick="cancelRequest()" id="cancelBtn" disabled>Cancel</button>

    <div id="question"></div>
    <div id="answer"></div>

    <div
      id="history-section"
      style="margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px"
    >
      <h2>Saved Questions</h2>
      <div id="history-controls">
        <button onclick="loadHistory()" id="historyToggleBtn">
          Load History
        </button>
        <button onclick="clearHistory()" id="clearHistoryBtn">
          Clear History
        </button>
        <button
          onclick="downloadCurrentHistory()"
          id="downloadHistoryBtn"
          style="display: none"
        >
          Download
        </button>
        <select id="historyDateSelect" style="display: none">
          <option value="">Select a date...</option>
        </select>
      </div>
      <div id="history-panel" style="display: none; margin-top: 20px">
        <div id="history-container">
          <div id="history-list">
            <!-- History items will be loaded here -->
          </div>
          <div
            id="history-detail"
            style="display: none; margin-top: 15px"
          ></div>
        </div>
      </div>
    </div>

    <div id="footer" style="margin-top: 20px; text-align: center; color: #888">
      <p>&copy; 2023 Audio Listener AI</p>
      <p>Version 1.0</p>
    </div>

    <!-- Load application scripts in the correct order -->
    <script src="./js/markdown-utils.js"></script>
    <script src="./js/animation.js"></script>
    <script src="./js/audio-device-manager.js"></script>
    <script src="./js/audio-recorder.js"></script>
    <script src="./js/audio-controls.js"></script>
    <script src="./js/socket-client.js"></script>
    <script src="./js/history-manager.js"></script>
    <script src="./js/main.js"></script>
  </body>
</html>
